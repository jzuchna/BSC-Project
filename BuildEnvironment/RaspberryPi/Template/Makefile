###############################################################################
# PROJECT     : Embedded Wizard Application Demo
###############################################################################
export MAKEFLAGS += --silent

###############################################################################
# GENERAL PROJECT CONFIGURATION
###############################################################################
APP_FILE           = EmWiApplication

###############################################################################
# GENERAL SETTINGS & PATHS
###############################################################################
BUILD_PATH        = ../Build

EMWI_APP_PATH     = ./GeneratedCode
EMWI_RTE_PATH     = ../PlatformPackage/RTE
EMWI_GFX_PATH     = ../PlatformPackage/RGBA8888
OBJ_PATH          = ./obj
BIN_PATH          = .
BSC_C_PATH	  = .

SDK_PATH          = /opt/vc
LIB_PATH          = $(SDK_PATH)/lib

###############################################################################
# Include standard rules and utilities
# Include Embedded Wizard configuration and list of generated source code
###############################################################################
include $(BUILD_PATH)/utilities.mk
include $(BUILD_PATH)/rules.mk

ifeq (,$(wildcard $(EMWI_APP_PATH)/ewfiles.inc))
  $(error ERROR: $n$nThe file '(EMWI_APP_PATH)/ewfiles.inc' is missing!\
    $nPlease open Embedded Wizard project and generate code before calling make!)
endif

include $(EMWI_APP_PATH)/ewfiles.inc
include $(EMWI_GFX_PATH)/ewgfx.inc
include $(EMWI_RTE_PATH)/ewrte.inc
include $(BSC_C_PATH)/BSCFiles.inc

###############################################################################
# Standard directories for C files
###############################################################################
vpath %.c           $(EMWI_APP_PATH)                                        \
                    $(EMWI_RTE_PATH)                                        \
                    $(EMWI_GFX_PATH)                                        \
		    ../../../Middleware/Source				    \
		    ../../../Common/Source				    \
		    ../../../Platform/RaspberryPi/Source		    \

##############################################################################
# EMBEDDED WIZARD - APPLICATION DEMO
###############################################################################
APP_C =                                                                        \
                    main.c                                                     \

# automatically compile all files generated by Embedded Wizard
APP_EMWI_C =        $(EMWIFILES)

# compile all files for the Embedded Wizard Runtime Environment (RTE)
RTE_EMWI_C =        $(EMWI_RTE_FILES)

# compile all files for the Embedded Wizard Graphics Engine (GFX)
GFX_EMWI_C =        $(EMWI_GFX_FILES)

# compile all Common C Files
COMMON_C = $(COMMONFILES)
PLATFORM_C = $(PLATFORMFILES)
MIDDLEWARE_C = $(MIDDLEWAREFILES)

###############################################################################
# LIBRARIES
###############################################################################
LIBS :=     m                                                                 \
            bcm_host                                                          \
            GLESv2                                                            \
            EGL                                                               \
            pthread 																													\
	    wiringPi                                                          \
            $(EMWI_RTE_LIB)                                                   \
            $(EMWI_GFX_LIB)                                                   \


###############################################################################
# INCLUDES
###############################################################################
INCLUDES =                                                                     \
            -I.                                                                \
            -I$(EMWI_APP_PATH)                                                 \
            -I$(EMWI_RTE_PATH)                                                 \
            -I$(EMWI_GFX_PATH)                                                 \
            -I$(SDK_PATH)/include                                              \
	    -I../../../Middleware/Include				       \
	    -I../../../Common/Include					       \
	    -I../../../Platform/RaspberryPi/Include			       \


###############################################################################
# DEFINES
###############################################################################
CFLAGS  = -O2 -Wall -pipe -lwiringPi                                                   \
          $(CFLAG_MEMORY_USAGE)                                                \


###############################################################################
# OBJECTS
###############################################################################
APP_OBJ           := $(foreach file,$(APP_C),             $(OBJ_PATH)/$(strip $(basename $(file))).o)
APP_EMWI_OBJ      := $(foreach file,$(APP_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
RTE_EMWI_OBJ      := $(foreach file,$(RTE_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
GFX_EMWI_OBJ      := $(foreach file,$(GFX_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
COMMON_OBJ	  := $(foreach file,$(COMMONFILES),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
PLATFORM_OBJ	  := $(foreach file,$(PLATFORMFILES),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
MIDDLEWARE_OBJ	  := $(foreach file,$(MIDDLEWAREFILES),        $(OBJ_PATH)/$(strip $(basename $(file))).o)


OBJS := $(APP_OBJ) $(APP_EMWI_OBJ) $(RTE_EMWI_OBJ) $(GFX_EMWI_OBJ) $(COMMON_OBJ) $(PLATFORM_OBJ) $(MIDDLEWARE_OBJ)

LINKING   = $(LD) $(addprefix -L,$(LIB_PATH)) $(OBJS)                          \
            $(addprefix -L,$(EMWI_RTE_PATH))                                   \
            $(addprefix -L,$(EMWI_GFX_PATH))                                   \
            $(addprefix -l,$(LIBS))                                            \
            -o $(BIN_PATH)/$(APP_FILE)


###############################################################################
# RULES
###############################################################################
$(APP_FILE): projectecho createdirs $(OBJS)
	@echo Linking $(APP_FILE)
	@echo $(LINKING)
	$(LINKING)
	@echo $(APP_FILE) successfully built !!

projectecho:
	@echo -------------------------------------------------
	@echo Creating $(APP_FILE)
	@echo -------------------------------------------------
	@echo Compiler Options: $(CCRUN_STD)

createdirs:
	@echo -------------------------------------------------
	@echo Creating object and library directories
	-$(MKDIR) $(OBJ_PATH)
	@echo -------------------------------------------------

.PHONY: clean
clean:
	@echo "Clean" $(OBJ_PATH)
	-$(RM) $(OBJ_PATH)/*.o
